<html>
    <script src="./mqtt.min.js"></script> 
    <script>
        const url = 'wss://traze.iteratec.de:9443';
        const clientName = makeId();
        const instance = "1";
        const subscriptions = {
            ['traze/' + instance + '/player/' + clientName]: onJoinSuccess,
            ['traze/' + instance + '/ticker']: onTicker,
            ['traze/' + instance + '/grid']: onGrid
        };
        let playerId = 0;
        let secretToken = "";
        let client = null;
        function connect () {
            client = mqtt.connect(url, {clientId: clientName});
            client.on('connect', () => {
                setStatus("Connected.");
                join();
            });
            client.on('error', (error) => {
                setStatus("Error: " + error);
            });
            client.on('message', function (topic, message) {
                console.log(message);
                if (subscriptions[topic]) {
                    subscriptions[topic](message);
                }
            });
            Object.keys(subscriptions).forEach(topic => {
                client.subscribe(topic);
            })
        }
        function join() {
            console.log("Join instance " + instance + " with clientName '" + clientName + "'");
            const joinMsg = {
                "name": "testNick",
                "mqttClientName": clientName
              };
            client.publish('traze/' + instance + "/join", JSON.stringify(joinMsg));
        }
        function onJoinSuccess(message) {
            setStatus("Joined as: " + message.name);
            playerId = message.id;
            secretToken = message.secretUserToken;
        }
        function onTicker(message) {
            if ((message.type == "frag" || message.type == "suicide") && message.casualty == playerId) {
                console.log('Died');
                setStatus('died');
                setTimeout(() => {
                    join();
                }, 3000);
            }
        }
        function onGrid(message) {
            
        }
        function setStatus(status) {
            document.querySelector("#status").innerHTML = status;
        }
        function makeId() {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
          
            for (var i = 0; i < 15; i++)
              text += possible.charAt(Math.floor(Math.random() * possible.length));
          
            return text;
        }
        function registerEvents() {
            document.querySelector("#steer-up").addEventListener('click', () => steer('N'));
            document.querySelector("#steer-down").addEventListener('click', () => steer('S'));
            document.querySelector("#steer-left").addEventListener('click', () => steer('W'));
            document.querySelector("#steer-right").addEventListener('click', () => steer('E'));
            document.querySelectorAll('.steer').forEach(element => {
                element.disabled = false;
            });
            document.addEventListener('keydown', event => {
                event = event || window.event;
                if (event.keyCode == '38') {
                    steer('N');
                } else if (event.keyCode == '40') {
                    steer('S');
                } else if (event.keyCode == '37') {
                    steer('W');
                } else if (event.keyCode == '39') {
                    steer('E');
                }            
            });
        }
        function steer(course) {
            if (!secretToken || !playerId || !client) {
                console.error("Not joined");
                return;
            }
            console.log('Steer: ' + course);
            const steerMsg = {
                course: course,
                playerToken: secretToken
            };
            client.publish('traze/' + instance + '/' + playerId + '/steer', JSON.stringify(steerMsg));
        }
        connect();
        window.addEventListener('load', () => registerEvents());
    </script>
    <body>
        <div id="status"></div>
        <div id="controls">
            <div><button id="steer-up" class="steer" disabled>Up</button></div>
            <div><button id="steer-left" class="steer" disabled>Left</button><button id="steer-right" class="steer" disabled>Right</button></div>
            <div><button id="steer-down" class="steer" disabled>Down</button></div>
        </div>
    </body>

</html>